name: Auto Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Get dependencies
        run: go mod download

      - name: Build for all platforms
        run: |
          mkdir -p dist
          
          # Build for different platforms
          platforms=(
            "linux/amd64"
            "linux/386"
            "linux/arm64"
            "linux/arm"
            "windows/amd64"
            "windows/386"
            "darwin/amd64"
            "darwin/arm64"
          )
          
          for platform in "${platforms[@]}"; do
            IFS='/' read -r os arch <<< "$platform"
            output_name="file-uploader-${os}-${arch}"
            
            if [ "$os" = "windows" ]; then
              output_name="${output_name}.exe"
            fi
            
            echo "Building for $os/$arch..."
            env GOOS=$os GOARCH=$arch CGO_ENABLED=0 go build \
              -ldflags="-s -w -X github.com/khasbulatabdullin/photo-uploader/internal/version.Version=${{ github.ref_name }}" \
              -o "dist/$output_name" ./cmd/photo-uploader
          done

      - name: Prepare binaries for release
        run: |
          cd dist
          echo "Preparing binaries for direct download..."
          ls -la

      - name: Generate release notes
        id: release_notes
        run: |
          # Determine language based on tag (if tag contains '-ru' use Russian, otherwise English)
          if [[ "${{ github.ref_name }}" == *"-ru"* ]]; then
            LANGUAGE="ru"
          else
            LANGUAGE="en"
          fi
          
          echo "language=$LANGUAGE" >> $GITHUB_ENV
          
          if [ "$LANGUAGE" = "ru" ]; then
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "# Загрузчик Файлов ${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "## 🚀 Универсальный загрузчик файлов для старых браузеров и мобильных устройств" >> $GITHUB_OUTPUT
          else
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "# File Uploader ${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "## 🚀 Universal File Uploader for Old Browsers and Mobile Devices" >> $GITHUB_OUTPUT
          fi
          echo "" >> $GITHUB_OUTPUT
          if [ "$LANGUAGE" = "ru" ]; then
            echo "### 📦 Загрузки" >> $GITHUB_OUTPUT
          else
            echo "### 📦 Downloads" >> $GITHUB_OUTPUT
          fi
          echo "" >> $GITHUB_OUTPUT
          for file in dist/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              if [ "$LANGUAGE" = "ru" ]; then
                echo "- \`$filename\` ($size) - Готов к запуску!" >> $GITHUB_OUTPUT
              else
                echo "- \`$filename\` ($size) - Ready to run!" >> $GITHUB_OUTPUT
              fi
            fi
          done
          echo "" >> $GITHUB_OUTPUT
          if [ "$LANGUAGE" = "ru" ]; then
            echo "### 📖 Документация" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- 🇷🇺 **Полная документация на русском**: [README.ru.md](https://github.com/Yakwilik/photo-uploader/blob/main/README.ru.md)" >> $GITHUB_OUTPUT
            echo "- 🇺🇸 **Complete documentation in English**: [README.md](https://github.com/Yakwilik/photo-uploader/blob/main/README.md)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### 🛠️ Установка и Использование" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "#### 📥 Быстрый Старт (Все Платформы)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "1. **Скачайте** подходящий бинарный файл для вашей платформы" >> $GITHUB_OUTPUT
            echo "2. **Разблокируйте файл** (см. инструкции ниже)" >> $GITHUB_OUTPUT
            echo "3. **Сделайте исполняемым** (только Unix системы): \`chmod +x file-uploader-*\`" >> $GITHUB_OUTPUT
            echo "4. **Запустите напрямую**: \`./file-uploader-*\` или дважды щелкните \`file-uploader-*.exe\` (Windows)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**Распаковка не нужна!** Файлы готовы к скачиванию и запуску сразу." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "#### 📁 Расположение файлов" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**Все загруженные файлы сохраняются в папку \`uploads/\`** в той же директории, где вы запустили приложение." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**Пример:**" >> $GITHUB_OUTPUT
            echo "\`\`\`" >> $GITHUB_OUTPUT
            echo "C:\\Users\\ВашеИмя\\Downloads\\file-uploader-windows-amd64.exe" >> $GITHUB_OUTPUT
            echo "C:\\Users\\ВашеИмя\\Downloads\\uploads\\          ← Ваши файлы здесь" >> $GITHUB_OUTPUT
            echo "\`\`\`" >> $GITHUB_OUTPUT
          else
            echo "### 📖 Documentation" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- 🇺🇸 **Complete documentation in English**: [README.md](https://github.com/Yakwilik/photo-uploader/blob/main/README.md)" >> $GITHUB_OUTPUT
            echo "- 🇷🇺 **Полная документация на русском**: [README.ru.md](https://github.com/Yakwilik/photo-uploader/blob/main/README.ru.md)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### 🛠️ Installation & Usage" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "#### 📥 Quick Start (All Platforms)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "1. **Download** the appropriate binary for your platform" >> $GITHUB_OUTPUT
            echo "2. **Unblock the file** (see instructions below)" >> $GITHUB_OUTPUT
            echo "3. **Make executable** (Unix systems only): \`chmod +x file-uploader-*\`" >> $GITHUB_OUTPUT
            echo "4. **Run directly**: \`./file-uploader-*\` or double-click \`file-uploader-*.exe\` (Windows)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**No extraction needed!** Files are ready to download and run immediately." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "#### 📁 File Location" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**All uploaded files are saved to the \`uploads/\` directory** in the same folder where you run the application." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**Example:**" >> $GITHUB_OUTPUT
            echo "\`\`\`" >> $GITHUB_OUTPUT
            echo "C:\\Users\\YourName\\Downloads\\file-uploader-windows-amd64.exe" >> $GITHUB_OUTPUT
            echo "C:\\Users\\YourName\\Downloads\\uploads\\          ← Your files are here" >> $GITHUB_OUTPUT
            echo "\`\`\`" >> $GITHUB_OUTPUT
          fi
          echo "" >> $GITHUB_OUTPUT
          if [ "$LANGUAGE" = "ru" ]; then
            echo "### 📱 Возможности" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- ✅ Универсальный загрузчик файлов для старых браузеров и мобильных устройств" >> $GITHUB_OUTPUT
            echo "- ✅ Совместим с IE9+, Safari 5+, Chrome 20+, iOS 9.3.5+, Android 4.0+" >> $GITHUB_OUTPUT
            echo "- ✅ Загрузка нескольких файлов одновременно" >> $GITHUB_OUTPUT
            echo "- ✅ Автоматическое определение IP адреса" >> $GITHUB_OUTPUT
            echo "- ✅ Отслеживание прогресса загрузки" >> $GITHUB_OUTPUT
            echo "- ✅ Поддержка любых типов файлов" >> $GITHUB_OUTPUT
            echo "- ✅ Доступ по локальной сети" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### ❓ Нужна Помощь?" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "Полная документация с инструкциями по установке, решению проблем и советами доступна в README файлах выше." >> $GITHUB_OUTPUT
          else
            echo "### 📱 Features" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- ✅ Universal file uploader for old browsers and mobile devices" >> $GITHUB_OUTPUT
            echo "- ✅ Compatible with IE9+, Safari 5+, Chrome 20+, iOS 9.3.5+, Android 4.0+" >> $GITHUB_OUTPUT
            echo "- ✅ Multiple file selection and upload" >> $GITHUB_OUTPUT
            echo "- ✅ Automatic IP address detection" >> $GITHUB_OUTPUT
            echo "- ✅ Progress tracking" >> $GITHUB_OUTPUT
            echo "- ✅ Support for any file types" >> $GITHUB_OUTPUT
            echo "- ✅ Local network access" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### ❓ Need Help?" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "Complete documentation with installation instructions, troubleshooting, and tips is available in the README files above." >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: File Uploader ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: dist/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
