name: Auto Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Get dependencies
        run: go mod download

      - name: Build for all platforms
        run: |
          mkdir -p dist
          
          # Build for different platforms
          platforms=(
            "linux/amd64"
            "linux/386"
            "linux/arm64"
            "linux/arm"
            "windows/amd64"
            "windows/386"
            "darwin/amd64"
            "darwin/arm64"
          )
          
          for platform in "${platforms[@]}"; do
            IFS='/' read -r os arch <<< "$platform"
            output_name="file-uploader-${os}-${arch}"
            
            if [ "$os" = "windows" ]; then
              output_name="${output_name}.exe"
            fi
            
            echo "Building for $os/$arch..."
            env GOOS=$os GOARCH=$arch CGO_ENABLED=0 go build \
              -ldflags="-s -w -X github.com/khasbulatabdullin/photo-uploader/internal/version.Version=${{ github.ref_name }}" \
              -o "dist/$output_name" ./cmd/photo-uploader
          done

      - name: Prepare binaries for release
        run: |
          cd dist
          echo "Preparing binaries for direct download..."
          ls -la

      - name: Generate release notes
        id: release_notes
        run: |
          # Determine language based on tag (if tag contains '-ru' use Russian, otherwise English)
          if [[ "${{ github.ref_name }}" == *"-ru"* ]]; then
            LANGUAGE="ru"
          else
            LANGUAGE="en"
          fi
          
          echo "language=$LANGUAGE" >> $GITHUB_ENV
          
          if [ "$LANGUAGE" = "ru" ]; then
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "# Ð—Ð°Ð³Ñ€ÑƒÐ·Ñ‡Ð¸Ðº Ð¤Ð°Ð¹Ð»Ð¾Ð² ${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "## ðŸš€ Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·Ñ‡Ð¸Ðº Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð¾Ð² Ð¸ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²" >> $GITHUB_OUTPUT
          else
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "# File Uploader ${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "## ðŸš€ Universal File Uploader for Old Browsers and Mobile Devices" >> $GITHUB_OUTPUT
          fi
          echo "" >> $GITHUB_OUTPUT
          if [ "$LANGUAGE" = "ru" ]; then
            echo "### ðŸ“¦ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸" >> $GITHUB_OUTPUT
          else
            echo "### ðŸ“¦ Downloads" >> $GITHUB_OUTPUT
          fi
          echo "" >> $GITHUB_OUTPUT
          for file in dist/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              if [ "$LANGUAGE" = "ru" ]; then
                echo "- \`$filename\` ($size) - Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ð·Ð°Ð¿ÑƒÑÐºÑƒ!" >> $GITHUB_OUTPUT
              else
                echo "- \`$filename\` ($size) - Ready to run!" >> $GITHUB_OUTPUT
              fi
            fi
          done
          echo "" >> $GITHUB_OUTPUT
          if [ "$LANGUAGE" = "ru" ]; then
            echo "### ðŸ“– Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- ðŸ‡·ðŸ‡º **ÐŸÐ¾Ð»Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼**: [README.ru.md](https://github.com/Yakwilik/photo-uploader/blob/main/README.ru.md)" >> $GITHUB_OUTPUT
            echo "- ðŸ‡ºðŸ‡¸ **Complete documentation in English**: [README.md](https://github.com/Yakwilik/photo-uploader/blob/main/README.md)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### ðŸ› ï¸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "#### ðŸ“¥ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð¡Ñ‚Ð°Ñ€Ñ‚ (Ð’ÑÐµ ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "1. **Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ** Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹" >> $GITHUB_OUTPUT
            echo "2. **Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»** (ÑÐ¼. Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð½Ð¸Ð¶Ðµ)" >> $GITHUB_OUTPUT
            echo "3. **Ð¡Ð´ÐµÐ»Ð°Ð¹Ñ‚Ðµ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼** (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Unix ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹): \`chmod +x file-uploader-*\`" >> $GITHUB_OUTPUT
            echo "4. **Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ**: \`./file-uploader-*\` Ð¸Ð»Ð¸ Ð´Ð²Ð°Ð¶Ð´Ñ‹ Ñ‰ÐµÐ»ÐºÐ½Ð¸Ñ‚Ðµ \`file-uploader-*.exe\` (Windows)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ° Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð°!** Ð¤Ð°Ð¹Ð»Ñ‹ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ðº ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸ÑŽ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÑƒ ÑÑ€Ð°Ð·Ñƒ." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "#### ðŸ“ Ð Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**Ð’ÑÐµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ Ð² Ð¿Ð°Ð¿ÐºÑƒ \`uploads/\`** Ð² Ñ‚Ð¾Ð¹ Ð¶Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸, Ð³Ð´Ðµ Ð²Ñ‹ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**ÐŸÑ€Ð¸Ð¼ÐµÑ€:**" >> $GITHUB_OUTPUT
            echo "\`\`\`" >> $GITHUB_OUTPUT
            echo "C:\\Users\\Ð’Ð°ÑˆÐµÐ˜Ð¼Ñ\\Downloads\\file-uploader-windows-amd64.exe" >> $GITHUB_OUTPUT
            echo "C:\\Users\\Ð’Ð°ÑˆÐµÐ˜Ð¼Ñ\\Downloads\\uploads\\          â† Ð’Ð°ÑˆÐ¸ Ñ„Ð°Ð¹Ð»Ñ‹ Ð·Ð´ÐµÑÑŒ" >> $GITHUB_OUTPUT
            echo "\`\`\`" >> $GITHUB_OUTPUT
          else
            echo "### ðŸ“– Documentation" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- ðŸ‡ºðŸ‡¸ **Complete documentation in English**: [README.md](https://github.com/Yakwilik/photo-uploader/blob/main/README.md)" >> $GITHUB_OUTPUT
            echo "- ðŸ‡·ðŸ‡º **ÐŸÐ¾Ð»Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼**: [README.ru.md](https://github.com/Yakwilik/photo-uploader/blob/main/README.ru.md)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### ðŸ› ï¸ Installation & Usage" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "#### ðŸ“¥ Quick Start (All Platforms)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "1. **Download** the appropriate binary for your platform" >> $GITHUB_OUTPUT
            echo "2. **Unblock the file** (see instructions below)" >> $GITHUB_OUTPUT
            echo "3. **Make executable** (Unix systems only): \`chmod +x file-uploader-*\`" >> $GITHUB_OUTPUT
            echo "4. **Run directly**: \`./file-uploader-*\` or double-click \`file-uploader-*.exe\` (Windows)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**No extraction needed!** Files are ready to download and run immediately." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "#### ðŸ“ File Location" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**All uploaded files are saved to the \`uploads/\` directory** in the same folder where you run the application." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**Example:**" >> $GITHUB_OUTPUT
            echo "\`\`\`" >> $GITHUB_OUTPUT
            echo "C:\\Users\\YourName\\Downloads\\file-uploader-windows-amd64.exe" >> $GITHUB_OUTPUT
            echo "C:\\Users\\YourName\\Downloads\\uploads\\          â† Your files are here" >> $GITHUB_OUTPUT
            echo "\`\`\`" >> $GITHUB_OUTPUT
          fi
          echo "" >> $GITHUB_OUTPUT
          if [ "$LANGUAGE" = "ru" ]; then
            echo "### ðŸ“± Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- âœ… Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·Ñ‡Ð¸Ðº Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð¾Ð² Ð¸ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²" >> $GITHUB_OUTPUT
            echo "- âœ… Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼ Ñ IE9+, Safari 5+, Chrome 20+, iOS 9.3.5+, Android 4.0+" >> $GITHUB_OUTPUT
            echo "- âœ… Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾" >> $GITHUB_OUTPUT
            echo "- âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ IP Ð°Ð´Ñ€ÐµÑÐ°" >> $GITHUB_OUTPUT
            echo "- âœ… ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸" >> $GITHUB_OUTPUT
            echo "- âœ… ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð»ÑŽÐ±Ñ‹Ñ… Ñ‚Ð¸Ð¿Ð¾Ð² Ñ„Ð°Ð¹Ð»Ð¾Ð²" >> $GITHUB_OUTPUT
            echo "- âœ… Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð¿Ð¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ ÑÐµÑ‚Ð¸" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### â“ ÐÑƒÐ¶Ð½Ð° ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ?" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "ÐŸÐ¾Ð»Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ñ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑÐ¼Ð¸ Ð¿Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ, Ñ€ÐµÑˆÐµÐ½Ð¸ÑŽ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ð¸ ÑÐ¾Ð²ÐµÑ‚Ð°Ð¼Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð² README Ñ„Ð°Ð¹Ð»Ð°Ñ… Ð²Ñ‹ÑˆÐµ." >> $GITHUB_OUTPUT
          else
            echo "### ðŸ“± Features" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- âœ… Universal file uploader for old browsers and mobile devices" >> $GITHUB_OUTPUT
            echo "- âœ… Compatible with IE9+, Safari 5+, Chrome 20+, iOS 9.3.5+, Android 4.0+" >> $GITHUB_OUTPUT
            echo "- âœ… Multiple file selection and upload" >> $GITHUB_OUTPUT
            echo "- âœ… Automatic IP address detection" >> $GITHUB_OUTPUT
            echo "- âœ… Progress tracking" >> $GITHUB_OUTPUT
            echo "- âœ… Support for any file types" >> $GITHUB_OUTPUT
            echo "- âœ… Local network access" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### â“ Need Help?" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "Complete documentation with installation instructions, troubleshooting, and tips is available in the README files above." >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: File Uploader ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: dist/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
